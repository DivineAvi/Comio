# Comio CI Pipeline
# Runs on every push and pull request to catch issues early.

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs of the same workflow on the same branch
# (saves CI minutes when you push multiple commits quickly)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─── Python Backend Checks ────────────────────────────────
  backend:
    name: Backend (Python)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        working-directory: apps/api
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" 2>/dev/null || pip install -e .
          pip install ruff mypy pytest pytest-asyncio

      - name: Lint with Ruff
        run: ruff check apps/api packages/

      - name: Format check with Ruff
        run: ruff format --check apps/api packages/

      - name: Type check with MyPy
        run: mypy apps/api --ignore-missing-imports
        continue-on-error: true  # Don't block CI while project is early stage

      - name: Run tests
        run: pytest apps/api packages/ --tb=short -q
        continue-on-error: true  # No tests yet, will fail gracefully

  # ─── Frontend Checks ──────────────────────────────────────
  frontend:
    name: Frontend (Next.js)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Lint with ESLint
        working-directory: apps/web
        run: npm run lint

      - name: Type check with TypeScript
        working-directory: apps/web
        run: npx tsc --noEmit

      - name: Build
        working-directory: apps/web
        run: npm run build